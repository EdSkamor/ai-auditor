<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <title>AI Auditor — Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --muted:#666; --bd:#e5e7eb; --bg:#fafafa; }
    body { font-family: system-ui, Arial, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 12px; }
    h1 { margin: 0 0 16px; }
    .bar { display:flex; align-items:center; gap:12px; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:#fff; }
    .pill { font-size:.9em; padding:4px 8px; border-radius:999px; border:1px solid var(--bd); background:var(--bg);}
    .ok { color: #047857; } .bad { color: #b91c1c; }
    .row { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; margin:14px 0; }
    textarea { width:100%; min-height:140px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; padding:10px; }
    .col { flex:1 1 360px; }
    .card { border:1px solid var(--bd); border-radius:10px; background:#fff; padding:12px; }
    ul { margin:8px 0; padding-left:18px; }
    code, pre { background:var(--bg); padding:2px 6px; border-radius:6px; }
    #out, #fileOut { white-space:pre-wrap; }
    button { padding:8px 14px; border-radius:8px; border:1px solid var(--bd); background:#fff; cursor:pointer; }
    button[disabled] { opacity:.5; cursor:not-allowed; }
    .muted{ color:var(--muted); font-size:.92em; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <h1>AI Auditor — Demo</h1>

  <div class="bar">
    <div>Status modelu: <span id="ready" class="pill bad">READY: false</span></div>
    <div class="muted">/healthz: <span id="health">…</span></div>
    <button id="refresh">Odśwież status</button>
  </div>

  <div class="row">
    <div class="col card">
      <h3>1) Wgraj plik (XLSX/CSV/TSV)</h3>
      <input type="file" id="file" />
      <div id="fileOut" class="muted"></div>
      <div id="prompts"></div>
    </div>

    <div class="col card">
      <h3>2) Zapytanie</h3>
      <textarea id="prompt" placeholder="Wklej/napisz zapytanie…"></textarea>
      <div class="muted">Wskazówka: kliknij „Wklej do zapytania” przy promptach z arkusza powyżej.</div>
      <div style="margin-top:10px;display:flex;gap:10px;">
        <button id="send">Wyślij do /analyze</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>3) Wynik</h3>
    <div id="out" class="muted">Brak wyniku.</div>
  </div>

<script>
const el = (id)=>document.getElementById(id);
const readyEl = el('ready'), healthEl = el('health'), outEl = el('out'), fileOutEl = el('fileOut'), promptsEl = el('prompts');
const sendBtn = el('send');

async function checkHealth(){
  try{
    const r = await fetch('/healthz'); healthEl.textContent = r.ok ? 'ok' : (r.status+'');
  }catch{ healthEl.textContent = 'error'; }
}
async function checkReady(){
  try{
    const r = await fetch('/ready'); const j = await r.json();
    readyEl.textContent = 'READY: '+j.model_ready;
    readyEl.classList.toggle('ok', !!j.model_ready);
    readyEl.classList.toggle('bad', !j.model_ready);
    sendBtn.disabled = !j.model_ready;
  }catch{
    readyEl.textContent = 'READY: ?'; sendBtn.disabled = true;
  }
}
el('refresh').onclick = ()=>{ checkHealth(); checkReady(); };

async function uploadFile(f){
  const fd = new FormData(); fd.append('file', f);
  fileOutEl.textContent = 'Wysyłam…';
  try{
    const r = await fetch('/analyze-file', { method:'POST', body: fd });
    const j = await r.json();
    if(!r.ok){ fileOutEl.textContent = 'Błąd: '+(j.detail || r.status); return; }
    // metryki
    fileOutEl.innerHTML = `
      <div><b>Plik:</b> ${j.filename}</div>
      <div><b>Wiersze:</b> ${j.shape?.[0] ?? '-'}, <b>Kolumny:</b> ${j.shape?.[1] ?? '-'}</div>
      <div><b>Kolumny:</b> <code>${(j.columns||[]).join(', ')}</code></div>
    `;
    // prompty
    const ps = Array.isArray(j.prompts) ? j.prompts.filter(Boolean) : [];
    if(ps.length){
      let html = '<h4>Prompty z arkusza</h4><ul>';
      ps.forEach((p,i)=>{
        const safe = String(p);
        html += `<li>${safe} <button data-i="${i}" class="paste">Wklej do zapytania</button></li>`;
      });
      html += '</ul>';
      promptsEl.innerHTML = html;
      promptsEl.querySelectorAll('.paste').forEach(btn=>{
        btn.onclick = ()=>{
          const i = Number(btn.getAttribute('data-i'));
          const cur = el('prompt').value.trim();
          el('prompt').value = (cur ? (cur+'\n\n') : '') + ps[i];
          el('prompt').focus();
        };
      });
    } else {
      promptsEl.innerHTML = '<div class="muted">Brak promptów w arkuszu (wiersze nad nagłówkiem puste).</div>';
    }
  }catch(e){
    fileOutEl.textContent = 'Błąd: '+e;
  }
}
el('file').addEventListener('change', (ev)=>{
  const f = ev.target.files?.[0];
  if(f) uploadFile(f);
});

sendBtn.onclick = async ()=>{
  const prompt = el('prompt').value.trim();
  if(!prompt){ outEl.textContent = 'Podaj treść zapytania.'; return; }
  outEl.textContent = 'Czekaj…';
  try{
    const r = await fetch('/analyze', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, max_new_tokens:220, do_sample:false })});
    const j = await r.json();
    if(!r.ok){ outEl.textContent = 'Błąd: '+(j.detail || r.status); return; }
    // render (z zachowaniem prostoty)
    outEl.innerHTML = marked.parse(String(j.output||'').trim() || '_brak treści_');
  }catch(e){
    outEl.textContent = 'Błąd: '+e;
  }
};

// pierwsze odpytywanie
checkHealth(); checkReady();
setInterval(checkReady, 3000);
</script>
</body>
</html>
