<!doctype html>
<html lang="pl" id="html-root">
<head>
  <meta charset="utf-8"/>
  <title id="page-title">AI Auditor — Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { 
      --muted:#666; 
      --bd:#e5e7eb; 
      --bg:#fafafa; 
      --text:#1f2937;
      --surface:#ffffff;
    }
    
    [data-theme="dark"] {
      --muted:#9ca3af;
      --bd:#374151;
      --bg:#1f2937;
      --text:#fafafa;
      --surface:#1f2937;
    }
    
    body { 
      font-family: system-ui, Arial, sans-serif; 
      max-width: 980px; 
      margin: 24px auto; 
      padding: 0 12px; 
      background-color: var(--surface);
      color: var(--text);
      transition: all 0.3s ease;
    }
    
    h1 { margin: 0 0 16px; }
    
    .controls { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      margin-bottom: 16px; 
      padding: 10px 12px; 
      border: 1px solid var(--bd); 
      border-radius: 10px; 
      background: var(--surface); 
    }
    
    .bar { 
      display:flex; 
      align-items:center; 
      gap:12px; 
      padding:10px 12px; 
      border:1px solid var(--bd); 
      border-radius:10px; 
      background:var(--surface); 
    }
    
    .pill { 
      font-size:.9em; 
      padding:4px 8px; 
      border-radius:999px; 
      border:1px solid var(--bd); 
      background:var(--bg);
    }
    
    .ok { color: #047857; } 
    .bad { color: #b91c1c; }
    
    .row { 
      display:flex; 
      gap:12px; 
      align-items:flex-start; 
      flex-wrap:wrap; 
      margin:14px 0; 
    }
    
    textarea { 
      width:100%; 
      min-height:140px; 
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace; 
      padding:10px; 
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--bd);
      border-radius: 6px;
    }
    
    .col { flex:1 1 360px; }
    
    .card { 
      border:1px solid var(--bd); 
      border-radius:10px; 
      background:var(--surface); 
      padding:12px; 
    }
    
    ul { margin:8px 0; padding-left:18px; }
    
    code, pre { 
      background:var(--bg); 
      padding:2px 6px; 
      border-radius:6px; 
    }
    
    #out, #fileOut { white-space:pre-wrap; }
    
    button { 
      padding:8px 14px; 
      border-radius:8px; 
      border:1px solid var(--bd); 
      background:var(--surface); 
      color: var(--text);
      cursor:pointer; 
      transition: all 0.3s ease;
    }
    
    button:hover {
      background: var(--bg);
      border-color: var(--muted);
      transform: translateY(-1px);
    }
    
    button[disabled] { 
      opacity:.5; 
      cursor:not-allowed; 
    }
    
    .muted{ 
      color:var(--muted); 
      font-size:.92em; 
    }
    
    .theme-toggle, .lang-toggle {
      background: var(--bg);
      border: 1px solid var(--bd);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .theme-toggle:hover, .lang-toggle:hover {
      background: var(--muted);
      color: var(--surface);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <h1 id="main-title">AI Auditor — Demo</h1>

  <div class="controls">
    <button class="theme-toggle" id="theme-toggle">🌙 Dark</button>
    <button class="lang-toggle" id="lang-toggle">🇵🇱 PL</button>
  </div>

  <div class="bar">
    <div><span id="model-status-text">Status modelu:</span> <span id="ready" class="pill bad">READY: false</span></div>
    <div class="muted">/healthz: <span id="health">…</span></div>
    <button id="refresh"><span id="refresh-text">Odśwież status</span></button>
  </div>

  <div class="row">
    <div class="col card">
      <h3 id="upload-title">1) Wgraj plik (XLSX/CSV/TSV)</h3>
      <input type="file" id="file" />
      <div id="fileOut" class="muted"></div>
      <div id="prompts"></div>
    </div>

    <div class="col card">
      <h3 id="query-title">2) Zapytanie</h3>
      <textarea id="prompt" placeholder="Wklej/napisz zapytanie…"></textarea>
      <div class="muted" id="query-hint">Wskazówka: kliknij „Wklej do zapytania" przy promptach z arkusza powyżej.</div>
      <div style="margin-top:10px;display:flex;gap:10px;">
        <button id="send">Wyślij do /analyze</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 id="results-title">3) Wynik</h3>
    <div id="out" class="muted">Brak wyniku.</div>
  </div>

<script>
// Translations
const translations = {
  pl: {
    'app_title': 'AI Auditor — Demo',
    'model_status': 'Status modelu:',
    'refresh': 'Odśwież status',
    'upload_title': '1) Wgraj plik (XLSX/CSV/TSV)',
    'query_title': '2) Zapytanie',
    'results_title': '3) Wynik',
    'query_placeholder': 'Wklej/napisz zapytanie…',
    'query_hint': 'Wskazówka: kliknij „Wklej do zapytania" przy promptach z arkusza powyżej.',
    'send_button': 'Wyślij do /analyze',
    'no_results': 'Brak wyniku.',
    'waiting': 'Czekaj…',
    'processing': 'Przetwarzanie…',
    'dark_mode': '🌙 Ciemny',
    'light_mode': '☀️ Jasny',
    'language_pl': '🇵🇱 PL',
    'language_en': '🇺🇸 EN'
  },
  en: {
    'app_title': 'AI Auditor — Demo',
    'model_status': 'Model status:',
    'refresh': 'Refresh status',
    'upload_title': '1) Upload file (XLSX/CSV/TSV)',
    'query_title': '2) Query',
    'results_title': '3) Results',
    'query_placeholder': 'Paste/write query…',
    'query_hint': 'Hint: click "Paste to query" for prompts from the sheet above.',
    'send_button': 'Send to /analyze',
    'no_results': 'No results.',
    'waiting': 'Waiting…',
    'processing': 'Processing…',
    'dark_mode': '🌙 Dark',
    'light_mode': '☀️ Light',
    'language_pl': '🇵🇱 PL',
    'language_en': '🇺🇸 EN'
  }
};

// State
let currentLanguage = 'pl';
let isDarkMode = false;

// Utility functions
const el = (id)=>document.getElementById(id);
const readyEl = el('ready'), healthEl = el('health'), outEl = el('out'), fileOutEl = el('fileOut'), promptsEl = el('prompts');
const sendBtn = el('send');

// Theme and language functions
function toggleTheme() {
  isDarkMode = !isDarkMode;
  const html = document.documentElement;
  const themeToggle = el('theme-toggle');
  
  if (isDarkMode) {
    html.setAttribute('data-theme', 'dark');
    themeToggle.textContent = translations[currentLanguage]['light_mode'];
  } else {
    html.removeAttribute('data-theme');
    themeToggle.textContent = translations[currentLanguage]['dark_mode'];
  }
  
  localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
}

function toggleLanguage() {
  currentLanguage = currentLanguage === 'pl' ? 'en' : 'pl';
  const langToggle = el('lang-toggle');
  const html = document.documentElement;
  
  html.setAttribute('lang', currentLanguage);
  langToggle.textContent = translations[currentLanguage][`language_${currentLanguage}`];
  
  // Update all text elements
  updateTranslations();
  localStorage.setItem('language', currentLanguage);
}

function updateTranslations() {
  const t = translations[currentLanguage];
  
  // Update page title
  document.title = t['app_title'];
  el('page-title').textContent = t['app_title'];
  el('main-title').textContent = t['app_title'];
  
  // Update status bar
  el('model-status-text').textContent = t['model_status'];
  el('refresh-text').textContent = t['refresh'];
  
  // Update sections
  el('upload-title').textContent = t['upload_title'];
  el('query-title').textContent = t['query_title'];
  el('results-title').textContent = t['results_title'];
  
  // Update form elements
  el('prompt').placeholder = t['query_placeholder'];
  el('query-hint').textContent = t['query_hint'];
  el('send').textContent = t['send_button'];
  
  // Update theme toggle
  const themeToggle = el('theme-toggle');
  themeToggle.textContent = isDarkMode ? t['light_mode'] : t['dark_mode'];
  
  // Update language toggle
  const langToggle = el('lang-toggle');
  langToggle.textContent = t[`language_${currentLanguage}`];
  
  // Update output if empty
  if (outEl.textContent === 'Brak wyniku.' || outEl.textContent === 'No results.') {
    outEl.textContent = t['no_results'];
  }
}

// Initialize theme and language from localStorage
function initializeUI() {
  // Load saved theme
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    isDarkMode = true;
    document.documentElement.setAttribute('data-theme', 'dark');
  }
  
  // Load saved language
  const savedLanguage = localStorage.getItem('language');
  if (savedLanguage && translations[savedLanguage]) {
    currentLanguage = savedLanguage;
    document.documentElement.setAttribute('lang', currentLanguage);
  }
  
  // Update UI
  updateTranslations();
  
  // Set up event listeners
  el('theme-toggle').addEventListener('click', toggleTheme);
  el('lang-toggle').addEventListener('click', toggleLanguage);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initializeUI);

async function checkHealth(){
  try{
    const r = await fetch('/healthz'); healthEl.textContent = r.ok ? 'ok' : (r.status+'');
  }catch{ healthEl.textContent = 'error'; }
}
async function checkReady(){
  try{
    const r = await fetch('/ready'); const j = await r.json();
    readyEl.textContent = 'READY: '+j.model_ready;
    readyEl.classList.toggle('ok', !!j.model_ready);
    readyEl.classList.toggle('bad', !j.model_ready);
    sendBtn.disabled = !j.model_ready;
  }catch{
    readyEl.textContent = 'READY: ?'; sendBtn.disabled = true;
  }
}
el('refresh').onclick = ()=>{ checkHealth(); checkReady(); };

async function uploadFile(f){
  const fd = new FormData(); fd.append('file', f);
  fileOutEl.textContent = translations[currentLanguage]['processing'];
  try{
    const r = await fetch('/analyze-file', { method:'POST', body: fd });
    const j = await r.json();
    if(!r.ok){ fileOutEl.textContent = 'Błąd: '+(j.detail || r.status); return; }
    // metryki
    const fileLabel = currentLanguage === 'pl' ? 'Plik:' : 'File:';
    const rowsLabel = currentLanguage === 'pl' ? 'Wiersze:' : 'Rows:';
    const colsLabel = currentLanguage === 'pl' ? 'Kolumny:' : 'Columns:';
    fileOutEl.innerHTML = `
      <div><b>${fileLabel}</b> ${j.filename}</div>
      <div><b>${rowsLabel}</b> ${j.shape?.[0] ?? '-'}, <b>${colsLabel}</b> ${j.shape?.[1] ?? '-'}</div>
      <div><b>${colsLabel}</b> <code>${(j.columns||[]).join(', ')}</code></div>
    `;
    // prompty
    const ps = Array.isArray(j.prompts) ? j.prompts.filter(Boolean) : [];
    if(ps.length){
      const promptsLabel = currentLanguage === 'pl' ? 'Prompty z arkusza' : 'Prompts from sheet';
      const pasteLabel = currentLanguage === 'pl' ? 'Wklej do zapytania' : 'Paste to query';
      let html = `<h4>${promptsLabel}</h4><ul>`;
      ps.forEach((p,i)=>{
        const safe = String(p);
        html += `<li>${safe} <button data-i="${i}" class="paste">${pasteLabel}</button></li>`;
      });
      html += '</ul>';
      promptsEl.innerHTML = html;
      promptsEl.querySelectorAll('.paste').forEach(btn=>{
        btn.onclick = ()=>{
          const i = Number(btn.getAttribute('data-i'));
          const cur = el('prompt').value.trim();
          el('prompt').value = (cur ? (cur+'\n\n') : '') + ps[i];
          el('prompt').focus();
        };
      });
    } else {
      const noPromptsMsg = currentLanguage === 'pl' ? 
        'Brak promptów w arkuszu (wiersze nad nagłówkiem puste).' : 
        'No prompts in sheet (empty rows above header).';
      promptsEl.innerHTML = `<div class="muted">${noPromptsMsg}</div>`;
    }
  }catch(e){
    fileOutEl.textContent = 'Błąd: '+e;
  }
}
el('file').addEventListener('change', (ev)=>{
  const f = ev.target.files?.[0];
  if(f) uploadFile(f);
});

sendBtn.onclick = async ()=>{
  const prompt = el('prompt').value.trim();
  const noPromptMsg = currentLanguage === 'pl' ? 'Podaj treść zapytania.' : 'Please provide query content.';
  if(!prompt){ outEl.textContent = noPromptMsg; return; }
  outEl.textContent = translations[currentLanguage]['waiting'];
  try{
    const r = await fetch('/analyze', { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ prompt, max_new_tokens:220, do_sample:false })});
    const j = await r.json();
    if(!r.ok){ outEl.textContent = 'Błąd: '+(j.detail || r.status); return; }
    // render (z zachowaniem prostoty)
    const noContentMsg = currentLanguage === 'pl' ? '_brak treści_' : '_no content_';
    outEl.innerHTML = marked.parse(String(j.output||'').trim() || noContentMsg);
  }catch(e){
    outEl.textContent = 'Błąd: '+e;
  }
};

// pierwsze odpytywanie
checkHealth(); checkReady();
setInterval(checkReady, 3000);
</script>
</body>
</html>
